#include <stdio.h>
#include <string.h>
#include <time.h>

typedef struct {
    int   units_limit;
    float rate_per_unit;
    char  label[20];
} Slab;

typedef struct {
    char name[50];
    char meter_no[15];
    int  prev_reading;
    int  curr_reading;
} Customer;

Slab slabs[] = {
    {  75,  3.50f, "Lifeline" },
    { 200,  5.14f, "Basic"    },
    { 300,  5.36f, "Mid"      },
    { 400,  5.63f, "High"     },
    { 500,  9.94f, "Premium"  },
    { 600, 11.46f, "Upper"    },
    {9999, 11.74f, "Max"      },
};

float VAT_RATE   = 0.05f;
float METER_RENT = 40.0f;
float DEMAND_CHG = 30.0f;

void loading_bar() {
    printf("\n  Calculating");
    for (int i = 0; i < 10; i++) {
        printf(".");
        fflush(stdout);
        for (volatile long j = 0; j < 8000000L; j++);
    }
    printf(" Done!\n\n");
}

float calculate_bill(int units, float *breakdown, int *num_slabs_used) {
    float total      = 0.0f;
    int   remaining  = units;
    int   prev_limit = 0;
    *num_slabs_used  = 0;

    for (int i = 0; i < 7 && remaining > 0; i++) {
        int slab_units = slabs[i].units_limit - prev_limit;
        int used       = (remaining < slab_units) ? remaining : slab_units;
        breakdown[i]   = used * slabs[i].rate_per_unit;
        total         += breakdown[i];
        remaining     -= used;
        prev_limit     = slabs[i].units_limit;
        (*num_slabs_used)++;
    }
    return total;
}

void print_bill(Customer *c) {
    int units = c->curr_reading - c->prev_reading;

    if (units < 0) {
        printf("  [!] ERROR: Current reading cannot be less than previous!\n");
        return;
    }

    float breakdown[7] = {0};
    int   slabs_used    = 0;
    float energy_charge = calculate_bill(units, breakdown, &slabs_used);
    float vat           = energy_charge * VAT_RATE;
    float grand_total   = energy_charge + vat + METER_RENT + DEMAND_CHG;

    time_t t = time(NULL);
    struct tm *tm_info = localtime(&t);
    char date_str[30];
    strftime(date_str, sizeof(date_str), "%d-%m-%Y", tm_info);

    loading_bar();

    printf("  +==================================================+\n");
    printf("  |        BANGLADESH POWER DEVELOPMENT BOARD        |\n");
    printf("  |              MONTHLY ELECTRICITY BILL            |\n");
    printf("  +==================================================+\n\n");

    printf("  Bill Date    : %s\n", date_str);
    printf("  Customer     : %s\n", c->name);
    printf("  Meter No.    : %s\n", c->meter_no);
    printf("  Prev Reading : %d kWh\n", c->prev_reading);
    printf("  Curr Reading : %d kWh\n", c->curr_reading);
    printf("  Total Units  : %d kWh\n", units);

    printf("\n  +----------+----------+-----------+-------------+\n");
    printf("  |              ENERGY CHARGE BREAKDOWN          |\n");
    printf("  +----------+----------+-----------+-------------+\n");
    printf("  |  Slab    |  Units   |  Rate(Tk) | Amount (Tk) |\n");
    printf("  +----------+----------+-----------+-------------+\n");

    int prev_limit = 0;
    for (int i = 0; i < slabs_used; i++) {
        int slab_max     = slabs[i].units_limit;
        int used_in_slab = (i == slabs_used - 1) ? (units - prev_limit) : (slab_max - prev_limit);
        printf("  |  %-8s|  %-8d|  %-9.2f|  Tk %-7.2f|\n",
               slabs[i].label, used_in_slab,
               slabs[i].rate_per_unit, breakdown[i]);
        prev_limit = slab_max;
    }

    printf("  +----------------------------------+-------------+\n");
    printf("  |  Energy Charge Total             |  Tk %-7.2f|\n", energy_charge);
    printf("  +----------------------------------+-------------+\n");
    printf("  |  VAT (5%%)                        |  Tk %-7.2f|\n", vat);
    printf("  |  Meter Rent                      |  Tk %-7.2f|\n", METER_RENT);
    printf("  |  Demand Charge                   |  Tk %-7.2f|\n", DEMAND_CHG);
    printf("  +----------------------------------+-------------+\n");
    printf("  |  GRAND TOTAL PAYABLE             |  Tk %-7.2f|\n", grand_total);
    printf("  +----------------------------------+-------------+\n\n");

    printf("  Usage Status : ");
    if      (units <= 75)  printf("Lifeline User  - Excellent! Keep saving.\n");
    else if (units <= 200) printf("Normal User    - Good consumption.\n");
    else if (units <= 400) printf("Moderate User  - Try to reduce usage.\n");
    else                   printf("High User      - Please reduce usage!\n");

    printf("\n  Tip: Turn off unused appliances to lower your bill.\n");
    printf("  ==================================================\n");
    printf("         Thank you for using BPDB Services!\n");
    printf("  ==================================================\n\n");
}

int main() {
    Customer c;
    char again = 'y';

    printf("\n  +======================================+\n");
    printf("  |   ELECTRICITY BILL CALCULATOR        |\n");
    printf("  |      Powered by C Programming        |\n");
    printf("  +======================================+\n\n");

    while (again == 'y' || again == 'Y') {

        printf("  Enter Customer Name         : ");
        fgets(c.name, sizeof(c.name), stdin);
        c.name[strcspn(c.name, "\n")] = '\0';

        printf("  Enter Meter Number          : ");
        fgets(c.meter_no, sizeof(c.meter_no), stdin);
        c.meter_no[strcspn(c.meter_no, "\n")] = '\0';

        printf("  Enter Previous Reading (kWh): ");
        scanf("%d", &c.prev_reading);

        printf("  Enter Current  Reading (kWh): ");
        scanf("%d", &c.curr_reading);
        getchar();

        print_bill(&c);

        printf("  Generate another bill? (y/n): ");
        scanf("%c", &again);
        getchar();
        printf("\n");
    }

    printf("  Exiting... Goodbye!\n\n");
    return 0;
}

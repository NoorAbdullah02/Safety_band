#include <stdio.h>
#include <stdlib.h>
#include <string.h>

void line() { printf("----------------------------------------\n"); }

float calcBill(float units) {
    if (units <= 100) return units * 1.50;
    if (units <= 200) return 150  + (units - 100) * 2.50;
    if (units <= 300) return 400  + (units - 200) * 4.00;
    if (units <= 500) return 800  + (units - 300) * 6.00;
    return              2000 + (units - 500) * 9.00;
}

float getTax(char *type) {
    if (strcmp(type, "2") == 0) return 0.08;
    if (strcmp(type, "3") == 0) return 0.10;
    return 0.05;
}

float getRent(char *type) {
    if (strcmp(type, "2") == 0) return 75;
    if (strcmp(type, "3") == 0) return 150;
    return 30;
}

void generateBill() {
    int id;
    char name[50], type[5];
    float prev, curr;

    printf("\n  Customer ID   : "); scanf("%d", &id);
    printf("  Name          : "); scanf(" %[^\n]", name);
    printf("  Prev Reading  : "); scanf("%f", &prev);
    printf("  Curr Reading  : "); scanf("%f", &curr);

    if (curr < prev) { printf("  ERROR: Invalid reading!\n"); return; }

    printf("  Type (1=Residential 2=Commercial 3=Industrial): ");
    scanf(" %s", type);

    float units    = curr - prev;
    float base     = calcBill(units);
    float surcharge = (base > 300) ? base * 0.15 : (base > 100) ? base * 0.10 : 0;
    float fuel     = units * 0.15;
    float rent     = getRent(type);
    float subtotal = base + surcharge + fuel + rent;
    float tax      = subtotal * getTax(type);
    float total    = subtotal + tax;

    printf("\n"); line();
    printf("  BILL SUMMARY - Customer: %s (ID: %d)\n", name, id);
    line();
    printf("  Units Consumed : %.2f kWh\n", units);
    printf("  Base Charge    : $%.2f\n", base);
    printf("  Surcharge      : $%.2f\n", surcharge);
    printf("  Fuel Adj.      : $%.2f\n", fuel);
    printf("  Meter Rent     : $%.2f\n", rent);
    printf("  Tax            : $%.2f\n", tax);
    line();
    printf("  TOTAL DUE      : $%.2f\n", total);
    line();
    if      (units <= 100) printf("  Status: LOW usage. Great!\n");
    else if (units <= 300) printf("  Status: MODERATE usage.\n");
    else                   printf("  Status: HIGH usage. Save energy!\n");
}

void bulkBilling() {
    int n;
    printf("\n  How many customers? "); scanf("%d", &n);
    float grand = 0;
    printf("\n  %-5s %-15s %10s %10s\n", "ID", "Name", "Units", "Bill($)");
    line();
    for (int i = 0; i < n; i++) {
        int id; char name[50]; float prev, curr;
        printf("  Customer %d ID   : ", i+1); scanf("%d", &id);
        printf("  Name            : "); scanf(" %[^\n]", name);
        printf("  Prev / Curr kWh : "); scanf("%f %f", &prev, &curr);
        float units = curr - prev;
        float bill  = calcBill(units) * 1.15;
        grand += bill;
        printf("  %-5d %-15s %10.2f %10.2f\n", id, name, units, bill);
    }
    line();
    printf("  GRAND TOTAL: $%.2f  |  Avg: $%.2f\n", grand, grand / n);
}

void slabInfo() {
    printf("\n"); line();
    printf("  SLAB RATES\n"); line();
    printf("  0   - 100 units : $1.50/unit\n");
    printf("  101 - 200 units : $2.50/unit\n");
    printf("  201 - 300 units : $4.00/unit\n");
    printf("  301 - 500 units : $6.00/unit\n");
    printf("  Above 500 units : $9.00/unit\n");
    line();
    printf("  Surcharge : 10%% (bill>$100)  15%% (bill>$300)\n");
    printf("  Fuel Adj  : $0.15 per unit\n");
    printf("  Meter Rent: $30 / $75 / $150 (Res/Com/Ind)\n");
    printf("  Tax       : 5%% / 8%% / 10%%  (Res/Com/Ind)\n");
    line();
}

void paymentDue() {
    float bill, days;
    printf("\n  Bill Amount  : $"); scanf("%f", &bill);
    printf("  Days Overdue : ");   scanf("%f", &days);
    float rate = (days > 60) ? 0.10 : (days > 30) ? 0.05 : (days > 15) ? 0.02 : 0;
    float penalty = bill * rate;
    printf("\n"); line();
    printf("  Original Bill  : $%.2f\n", bill);
    printf("  Penalty (%.0f%%) : $%.2f\n", rate * 100, penalty);
    printf("  TOTAL DUE      : $%.2f\n", bill + penalty);
    line();
    if (days == 0)      printf("  ON TIME - No penalty.\n");
    else if (days <= 15) printf("  GRACE PERIOD - Pay now!\n");
    else                 printf("  OVERDUE - %.0f%% penalty applied.\n", rate * 100);
}

void exportBill() {
    int id, month, year;
    char name[50], type[5];
    float prev, curr;

    printf("\n  ID     : "); scanf("%d", &id);
    printf("  Name   : "); scanf(" %[^\n]", name);
    printf("  Prev / Curr Reading: "); scanf("%f %f", &prev, &curr);
    printf("  Type (1/2/3): "); scanf(" %s", type);
    printf("  Month / Year: "); scanf("%d %d", &month, &year);

    float units    = curr - prev;
    float base     = calcBill(units);
    float sur      = (base > 300) ? base*0.15 : (base > 100) ? base*0.10 : 0;
    float fuel     = units * 0.15;
    float rent     = getRent(type);
    float sub      = base + sur + fuel + rent;
    float tax      = sub * getTax(type);
    float total    = sub + tax;

    char fname[40];
    snprintf(fname, sizeof(fname), "bill_%d_%d_%d.txt", id, month, year);
    FILE *fp = fopen(fname, "w");
    if (!fp) { printf("  ERROR: Cannot create file.\n"); return; }

    fprintf(fp, "========================================\n");
    fprintf(fp, "  ELECTRICITY BILL  |  %d/%d\n", month, year);
    fprintf(fp, "========================================\n");
    fprintf(fp, "  ID     : %d\n  Name   : %s\n", id, name);
    fprintf(fp, "  Units  : %.2f kWh\n", units);
    fprintf(fp, "  Base   : $%.2f\n  Sur    : $%.2f\n", base, sur);
    fprintf(fp, "  Fuel   : $%.2f\n  Rent   : $%.2f\n", fuel, rent);
    fprintf(fp, "  Tax    : $%.2f\n", tax);
    fprintf(fp, "========================================\n");
    fprintf(fp, "  TOTAL  : $%.2f\n", total);
    fprintf(fp, "========================================\n");
    fclose(fp);
    printf("  Saved to: %s\n", fname);
}

int main() {
    int choice;
    while (1) {
        printf("\n========================================\n");
        printf("    ELECTRICITY BILL CALCULATOR\n");
        printf("========================================\n");
        printf("  1. Generate Bill\n");
        printf("  2. Bulk Billing\n");
        printf("  3. Slab Rate Info\n");
        printf("  4. Payment Due Calculator\n");
        printf("  5. Export Bill to File\n");
        printf("  0. Exit\n");
        printf("----------------------------------------\n");
        printf("  Choice: "); scanf("%d", &choice);

        switch (choice) {
            case 1: generateBill(); break;
            case 2: bulkBilling();  break;
            case 3: slabInfo();     break;
            case 4: paymentDue();   break;
            case 5: exportBill();   break;
            case 0:
                printf("\n  Goodbye! Save energy!\n\n");
                return 0;
            default:
                printf("  Invalid choice!\n");
        }

        printf("\n  Press ENTER to continue...");
        while (getchar() != '\n');
        getchar();
    }
}
